CREATE TABLE IF NOT EXISTS book (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY,
    name VARCHAR(255) NOT NULL,
    authors VARCHAR(255) NOT NULL,
    price INTEGER NOT NULL,
    isbn VARCHAR(13) NOT NULL,
    publisher VARCHAR(255) NOT NULL,
    publish_date DATE NOT NULL,
    description TEXT,
    quantity INTEGER DEFAULT 0,
    availability BOOLEAN DEFAULT FALSE,
    primary key (id)
);

create table if not exists Image (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY,
    content blob,
    content_type varchar(255),
    filename varchar(255),
    book_id bigint,
    primary key (id),
    foreign key (book_id) references book ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS BOOK_USER (
    username VARCHAR(30) NOT NULL,
    password VARCHAR(255) NOT NULL,
    CONSTRAINT username_length CHECK (LENGTH(USERNAME) >= 5),
    PRIMARY KEY (username)
);

CREATE TABLE IF NOT EXISTS USER_ROLE (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY,
    username VARCHAR(30) NOT NULL,
    ROLE VARCHAR(30) NOT NULL,
    FOREIGN KEY (username) REFERENCES BOOK_USER ON DELETE CASCADE

);

CREATE TABLE IF NOT EXISTS customer (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY,
    firstname VARCHAR(50) NOT NULL,
    lastname VARCHAR(50) NOT NULL,
    email VARCHAR(254) NOT NULL,
    phone VARCHAR(15) NOT NULL,
    country VARCHAR(55) NOT NULL,
    city VARCHAR(60) NOT NULL,
    address1 VARCHAR(100) NOT NULL,
    address2 VARCHAR(100),
    postal_code VARCHAR(18),
    username VARCHAR(255),
    PRIMARY KEY (id),
    FOREIGN KEY (username) REFERENCES BOOK_USER(username) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS comment (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY,
    username VARCHAR(30) NOT NULL,
    book_id BIGINT NOT NULL,
    date TIMESTAMP NOT NULL,
    comment TEXT NOT NULL,

    PRIMARY KEY (id),
    FOREIGN KEY (username) REFERENCES BOOK_USER(username) ON DELETE CASCADE,
    FOREIGN KEY (book_id) REFERENCES book(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS ORDERS (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY,
    username VARCHAR(30) NOT NULL,
    order_date TIMESTAMP NOT NULL,
    total DECIMAL (10, 2) NOT NULL,
    firstname VARCHAR(50) NOT NULL,
    lastname VARCHAR(50) NOT NULL,
    email VARCHAR(254) NOT NULL,
    phone VARCHAR(15) NOT NULL,
    country VARCHAR(55) NOT NULL,
    city VARCHAR(60) NOT NULL,
    address1 VARCHAR(100) NOT NULL,
    address2 VARCHAR(100),
    postal_code VARCHAR(18),
    PRIMARY KEY (id),
    FOREIGN KEY (username) REFERENCES BOOK_USER(username) on DELETE set null
);

CREATE TABLE IF NOT EXISTS order_book (
    order_id BIGINT NOT NULL,
    book_id BIGINT NOT NULL,
    quantity INT NOT NULL DEFAULT 1,
    PRIMARY KEY (order_id, book_id),
    FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE,
    FOREIGN KEY (book_id) REFERENCES book(id)
);

CREATE TABLE IF NOT EXISTS bookmark (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(30) NOT NULL,
    book_id BIGINT NOT NULL,
    FOREIGN KEY (username) REFERENCES BOOK_USER(username) ON DELETE CASCADE,
    FOREIGN KEY (book_id) REFERENCES book(id) ON DELETE CASCADE,
    CONSTRAINT unique_user_book UNIQUE (username, book_id)
);